<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>üé® Flipboard 3D Gallery - Preview</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Courier New', monospace;
      background: #000;
      color: #fff;
      display: flex; 
      flex-direction: column;
      align-items: center; 
      justify-content: center; 
      min-height: 100vh; 
      padding: 0;
      margin: 0;
      overflow: hidden;
    }
    
    .header {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 100;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
    }

    h1 {
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .status {
      font-size: 11px;
      color: #888;
    }

    /* Flipboard display preview - Full screen */
    .flipboard-preview {
      width: 100vw;
      height: 100vh;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    #flipboard-frame {
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      image-rendering: -moz-crisp-edges;
      image-rendering: -webkit-crisp-edges;
      width: 100vw;
      height: 100vh;
      object-fit: contain;
      display: block;
      background: #000;
    }

    .info {
      position: fixed;
      bottom: 10px;
      left: 10px;
      z-index: 100;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px;
      border-radius: 5px;
      font-size: 11px;
      color: #aaa;
    }

    .info p {
      margin: 4px 0;
    }
    
    .controls {
      position: fixed;
      bottom: 10px;
      right: 10px;
      z-index: 100;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px;
      border-radius: 5px;
    }

    button {
      background: #333;
      color: #fff;
      border: 1px solid #555;
      padding: 6px 12px;
      margin: 3px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 11px;
    }
    
    button:hover {
      background: #555;
      border-color: #777;
    }

    .error {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 200;
      color: #f44;
      padding: 20px;
      border: 2px solid #f44;
      background: rgba(0, 0, 0, 0.9);
      text-align: center;
      font-size: 14px;
    }

    .loading {
      color: #888;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üé® Flipboard 3D Gallery - Live Preview</h1>
    <div class="status" id="status">Connecting to server...</div>
  </div>

  <div class="flipboard-preview">
    <div id="loading-spinner" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 14px;">
      Loading frames...
    </div>
    <img id="flipboard-frame" src="" alt="Flipboard Frame" style="display: none;" />
  </div>

  <div class="info">
    <p><strong>Display Size:</strong> 84√ó28 pixels (3:1 aspect ratio)</p>
    <p><strong>Resolution:</strong> Black & White binary (exactly as sent to flipboard)</p>
    <p><strong>Frame Rate:</strong> 15 FPS</p>
    <p><strong>Server:</strong> <span id="server-status">Not connected</span></p>
    </div>
    
    <div class="controls">
    <button onclick="location.reload()">üîÑ Refresh</button>
    <button onclick="toggleAutoRefresh()">‚è∏Ô∏è <span id="auto-refresh-text">Pause</span></button>
    <button onclick="saveFrame()">üíæ Save Frame</button>
  </div>
  
  <div id="error" class="error" style="display: none;"></div>
  
  <script>
    // Detect base path from current location
    // If we're at /api-testing/room.html, base path is /api-testing
    // If we're at /room.html, base path is empty
    const pathParts = window.location.pathname.split('/').filter(p => p);
    const basePath = pathParts.length > 1 ? '/' + pathParts.slice(0, -1).join('/') : '';
    const API_BASE = window.location.origin + basePath;
    const frameImg = document.getElementById('flipboard-frame');
    const statusEl = document.getElementById('status');
    const serverStatusEl = document.getElementById('server-status');
    const errorEl = document.getElementById('error');
    let autoRefresh = true;
    let frameCount = 0;
    let lastUpdate = Date.now();
    let errorCount = 0;
    
    console.log('üé® Initializing frame viewer...');
    console.log('üìç Current path:', window.location.pathname);
    console.log('üìç Detected base path:', basePath);
    console.log('üìç API Base:', API_BASE);
    
    function updateFrame() {
      const timestamp = Date.now();
      // Add timestamp to prevent caching
      const frameUrl = `${API_BASE}/api/frame?t=${timestamp}`;
      console.log('üì° Fetching frame:', frameUrl);
      frameImg.src = frameUrl;
    }
    
    frameImg.onload = () => {
      frameCount++;
      errorCount = 0; // Reset error count on success
      lastUpdate = Date.now();

      // Show image once first frame loads
      if (frameCount === 1) {
        frameImg.style.display = 'block';
        const spinner = document.getElementById('loading-spinner');
        if (spinner) spinner.style.display = 'none';
        console.log('‚úÖ First frame loaded successfully!');
      }
      
      statusEl.textContent = `Frame #${frameCount} | Last update: ${new Date().toLocaleTimeString()}`;
      serverStatusEl.textContent = 'Connected';
      errorEl.style.display = 'none';
      
      if (autoRefresh) {
        setTimeout(updateFrame, 1000 / 15); // 15 FPS
      }
    };
    
    function handleError(err) {
      errorCount++;
      errorEl.textContent = `Error: ${err.message || 'Failed to load frame'} (attempt ${errorCount})`;
      errorEl.style.display = 'block';
      serverStatusEl.textContent = 'Disconnected';
      statusEl.textContent = `Connection error - make sure server is running on ${API_BASE}`;
      console.error('‚ùå Frame load error:', err);
    }
    
    frameImg.onerror = (e) => {
      console.error('‚ùå Image load error:', e);
      console.error('   Attempted URL:', frameImg.src);
      handleError(new Error(`Failed to load frame from ${API_BASE}/api/frame`));
      if (autoRefresh) {
        setTimeout(updateFrame, 2000); // Retry after 2 seconds
      }
    };
    
    function toggleAutoRefresh() {
      autoRefresh = !autoRefresh;
      const textEl = document.getElementById('auto-refresh-text');
      textEl.textContent = autoRefresh ? 'Pause' : 'Resume';
      
      if (autoRefresh) {
        updateFrame();
    }
    }
    
    // Test server connection first
    fetch(`${API_BASE}/health`)
      .then(res => res.json())
      .then(data => {
        console.log('‚úÖ Server health check:', data);
        serverStatusEl.textContent = 'Server online';
        // Start loading frames after health check
        console.log('üöÄ Starting frame updates...');
        updateFrame();
      })
      .catch(err => {
        console.error('‚ùå Server health check failed:', err);
        console.error('   Make sure the server is running on', API_BASE);
        handleError(new Error('Cannot connect to server. Is it running?'));
        // Still try to load frames
        console.log('üöÄ Starting frame updates (will retry on error)...');
        updateFrame();
      });
    
    // Save current frame to disk (on demand)
    function saveFrame() {
      fetch(`${API_BASE}/api/save-frame`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            statusEl.textContent = `‚úÖ Frame saved: ${data.filename}`;
            setTimeout(() => {
              statusEl.textContent = `Frame #${frameCount} | Last update: ${new Date().toLocaleTimeString()}`;
            }, 3000);
          } else {
            handleError(new Error(data.error || 'Failed to save frame'));
          }
        })
        .catch(err => {
          handleError(err);
        });
    }
    
    // Check server health
    fetch(`${API_BASE}/health`)
      .then(res => res.json())
      .then(data => {
        console.log('Server health:', data);
      })
      .catch(err => {
        console.error('Server health check failed:', err);
        handleError(err);
      });
  </script>
</body>
</html>
